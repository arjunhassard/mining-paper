\documentclass[longbibliography,nofootinbib,twocolumn]{revtex4-1}

\newcommand{\kms}{NuCypher KMS}

\usepackage{listings}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage[margin=5pt]{subfig}
\usepackage[usenames]{color}

\renewcommand{\baselinestretch}{1.4}
\setlength{\parskip}{1em}
\definecolor{darkgreen}{rgb}{0.00,0.50,0.25}
\definecolor{darkblue}{rgb}{0.00,0.00,0.67}
\newcommand{\figref}[1]{Fig.~\ref{#1}}
\usepackage[breaklinks,pdftitle={NuCypher KMS: Mining}, pdfauthor={Michael Egorov},colorlinks,urlcolor=blue,citecolor=darkgreen,linkcolor=darkblue]{hyperref}
\graphicspath{{pdf/}}

\usepackage[T1]{fontenc}
\usepackage{lmodern}
\lstset{
    basicstyle=\ttfamily,
    basewidth={0.5em, 0.5em},
    columns=fullflexible,
}

\begin{document}

\title{\kms: Mining}

\author{Michael Egorov}
\email{michael@nucypher.com}
\affiliation{NuCypher}

\begin{abstract}
    This paper describes mining mechanisms and economics in \kms.
    It includes inflation rates, mechanisms to incentivise long-term stakers
    and estimates of number of coins generated by nodes running in typical modes.
    Also, optimal strategies for stakers who may be affected by market volatility are proposed.
\end{abstract}

\date{\today}
\maketitle

\section{Motivation}

In future, \kms~will probably be fully paid by network fees.
But initially, when the adoption isn't yet high, miners who run the nodes necessary for network operation and keep re-encryption keys,
will need to be subsidised.
This will be done through inflation schedule, where all the inflation is given back to miners.

Distribution of rewards should have the following properties:
\begin{itemize}
    \item All the inflation is distributed to stakers who run the nodes, proportionally to the stake;
    \item Amount of work (and, hence, the fees) is proportional to stake also;
    \item Stakers are incentivized (by a higher reward rate) to run long-term nodes;
    \item High inflation doesn't depreciate the price in order to keep liquidity good for new stakers;
    \item Stakers are incentivized to stay online all the time.
\end{itemize}

In the paper we address all these points, calculate expected earnings of miners who run nodes and devise optimal mining strategies.

\section{Historical examples of inflation}

Let's review inlation schedules of different cryptocurrency projects:
DASH~\cite{dash:whitepaper} and ZCash~\cite{zcash}.

Dash has a hybrid of Proof-of-Work (POW) and Proof-of-Stake (POS).
It has $45\%$ of inflation going to POW miners, $45\%$ to staking master nodes and $10\%$ is reserved for budget proposals~\cite{dash:emission}.
After the first year, its emission was $18.42\%$ APR, decreasing by $1/14$ every $383$ days.
With this setting, $60\%$ of DASH coins are locked in masternodes for staking, according to the node statistics.
It's unclear how inflation rate affects the price (and if it does here), but the useful data point is that there are $60\%$ of coins locked for staking.
Perhaps, that is something to expect in a network where staking is an option.

% TODO: replot in a more reasonable shape
\begin{figure}
    \includegraphics[width=\columnwidth]{pdf/zcash-price.pdf}
    \caption{Historical price of ZCash in logarithmic scale. Note the minimum at 23 Feb 2017}
    \label{fig:zec}
\end{figure}

ZCash is very interesting in a way that it started from an extremely high inflation (percent-wise).
This caused a short-term price drop (even though the market capitalization was growing)~(\figref{fig:zec}).
But at some point (23~Feb~2017), the price started going up.
ZCash block rewards yield $50$~ZEC every $10$~min, and ZEC supply at Feb~23 was $727$k~ZEC.
This corresponds to $360\%$~APR.
It is even more remarkable given the fact that miners who mined ZEC are probably those who dump and exchange the proceeds into something else (and also pay
electricity bills).
This gives us information about what would be the maximum allowable inflation which still doesn't create a too high down pressure for the price.

\section{Mining protocol}

Miner commits to stay available for at least certain time $T$.
If the tokens were locked for this whole time $T$ and abruptly unlocked after that, we'd have a problem with a pre-locked preallocation:
a huge increase of tokens in circulation right after the time $T$ would probably crash the market.

\begin{figure}
    \includegraphics[width=\columnwidth]{pdf/mining-modes.pdf}
    \caption{
        Mining modes: \emph{steady state} (before $t_1$) and \emph{ramp down} (from $t_1$ till $t_1 + T$).
        The ramp down (or vesting) time $T$ is chosen by the miner (and he gets higher staking rewards when $T$ is higher).
    }
    \label{fig:mining-modes}
\end{figure}

In order to avoid that, we introduce two modes of miner operation: \emph{steady state} and \emph{ramp down}.
When miner is in steady state, his base coins stay locked.
Block rewards are created, and they aren't necessarily locked (unless the miner chooses to add newly minted coins to the locked amount).

At any point of time, the miner can switch to \emph{ramp down}.
This would start unlocking the coins which he stakes linearly, during the time $T$.
Both, \emph{steady state} mode and \emph{ramp down} starting at the point $t_1$ are shown at (\figref{fig:mining-modes}).
So, the time $T$ doesn't mean the total time during which miner's tokens are locked, but rather how quickly do the tokens get unlocked once he starts
unlocking.


\section{General inflation properties}

\subsection{Initial inflation}

Let's assume that we'll have the same number of tokens locked as DASH has: $\lambda=60\%$.
Then we'll have $1-\lambda=40\%$ in circulation.
If we have inflation rate $I$, then adjusted inflation rate (e.g. inflation as if the locked coins didn't exist) of coins in circulation will be:
\begin{equation}
    I^* = \frac{I}{1-\lambda},
\end{equation}
and we should be comparing $I^*$ with historical examples of inflation.
If we take $I^*=350\%$ (turnover point of ZCash price in an overall bullish market), the corresponding inflation $I$ will be $140\%$~APR.

To be on the safe side, we choose the starting inflation to be $I_0=100\%$~APR (or, in other words, $1/365$ per day).

\subsection{Inflation decay}

Initially, the inflation subsidises mining, but payments for re-encryption services will provide all the revenues of miners in the long run.
If all miners have the same, maximum reward rate, we choose the inflation rate to decay by factor of $2$ in $T_{1/2} = 2$ years.
The inflation, depending on time passed from the Genesis $t$, looks like:
\begin{equation}
    I(t) = I_0 \cdot 2^{-\frac{t}{T_{1/2}}} = I_0 \exp\left[ -\ln{2} \frac{t}{T_{1/2}} \right].
\end{equation}
In this case, the dependence of the token supply on the time $t$ is:
\begin{equation}
    \label{eq:supply-time}
    S(t) = S_0 + \int_0^{t} I(t)\, dt = S_0 + \frac{I_0 T_{1/2}}{\ln{2}}\left[1 - 2^{-\frac{t}{T_{1/2}}} \right],
\end{equation}
Conveniently, $I_0=100\%$~APR is $I_0=S_0$~per~year, and the maximum number of tokens which will ever be created is:
\begin{equation}
    S_{\max} = S(\infty) = S_0\left(1 + \frac{T_{1/2}}{\ln{2}}\right) \approx 3.89\, S_0,
\end{equation}
where $S_0$ is initial number of tokens.

\subsection{Implementation of the exponential decay in a smart contract}

Complex functions like exponentials, if implemented in smart contracts, would be quite costly.
Fortunately, the exponential is a solution of a differential equation where inflation is proportional to the amount of yet not mined coins:
\begin{eqnarray}
    I(t) &=& \frac{\ln{2}}{T_{1/2}} \left( S_{\max} - S(t) \right)\\
    dS &=& I(t)\, dt,
\end{eqnarray}
where $S(t)$ is the current token supply with $S(0)=S_0$ and the time step $dt$ can actually be equal to the mining period ($1$~day).
Each mining node can trivially calculate its $dS$ in a smart contract using very few operations and the coin supply $S$ from the last period.
So, the amount of coins mined for the node $i$ and the time period $t$ will be:
\begin{eqnarray}
    \label{eq:rate-max}
    ds_{i,t} &=& \frac{l_i}{L} \frac{\ln{2}}{T_{1/2}} \left( S_{\max} - S_{t-1} \right),\\
    dS_t &=& \sum_i ds_{i,t},
\end{eqnarray}
where $l_i$ is the number of coins locked by the miner $i$, $L$ is the total number of coins locked.
Instead of calculating all the sum over $i$, each miner $i$ can add her portion $ds_{i,t}$.

\subsection{Mining rate and staking time}

We want to incentivize miners to keep serving re-encryption policies for at least $1$~year.
However, short-term stakers are still useful and should be rewarded.
We will give the full reward ($\kappa=1$) to the stakers who are committed to stake at least $T_1=1$~year,
however those who stake for $T_{\min}=1$~month will get half the reward ($\kappa=0.5$).
So, the individual daily reward rate for a miner looks as:
\begin{eqnarray}
    \kappa &=& \left(0.5 + 0.5\frac{\min(T_i, T_1) - T_{\min}}{T_1 - T_{\min}}\right)\\
    T_i &\ge& T_{\min},\\
    \delta s_{i,t} &=&  \kappa\, \frac{l_i}{L} \frac{\ln{2}}{T_{1/2}} \left( S_{\max} - S_{t-1}\right).\\
\end{eqnarray}

This has implications on the global token economy.
Firstly, if stakers, despite smaller reward, prefer to stake for shorter, that creates smaller daily token supply.
Since this usually should coincide with bear market, reducing the issuance during that time sounds like a good idea.

Interestingly enough, $\kappa < 1$ prolongs the reward half-decay time $T_{1/2}^* = T_{1/2} / \kappa$.
If all the stakers have $\kappa = 0.5$, this prolongs $T_{1/2}$ to be $4$~years instead of $2$.

\section{Mining strategies and expected rewards}

In this section, we look at three possibilities: miner taking all the block rewards, miner adding all the rewards to what's currently staked and miner spinning
the node down to get all the coins unlocked after the time $T$ (as well as the rewards).
Every of these possibilities could have different distributions of $\kappa$.
Let's consider $\kappa=1$ and $\kappa=0.5$ as two marginal values.
Let's take amount of coins locked to be $\lambda=60\%$, as in DASH.
We'll plot graphs of daily rewards, as well as calculate the rewards during the first year in each of these scenarios.

\subsection{Withdraw mining compensation}

This is the simplest case.
The amount of coins staked can be expressed as $L=\lambda S$.
The amount of stake stays constant in this case and equal to $s_i = l$, and the mining rate (e.g. the cumulative rewards) is:
\begin{equation}
    \frac{dr}{dt} =  \kappa\, \frac{l}{\lambda S(t)} \frac{\ln{2}}{T_{1/2}} \left( S_{\max} - S(t)\right).
\end{equation}
When we substitute $S(t)$ from Eq.~\ref{eq:supply-time} and integrate over time, we find total rewards:
\begin{equation}
    r(t) = \frac{\kappa}{\lambda} l \ln\frac{S(t)}{S_0}.
\end{equation}

If $\kappa=1$ (staking for $1$~year+) and $\lambda=60\%$ ($60\%$ of all nodes in the network are staking),
miner's compensation starts from $0.46\%$~per~day in NKMS tokens,
or $100.2\%$ during the first year of staking.

\subsection{Restake mining compensation}

Instead of taking all the mining compensation, it could be restaked into the node in order to get even more jobs and, provided that the hardware is maintained
powerful enough to cope with those, get even higher compensation.
In this case, the actual stake $l$ is constantly increasing with time:
\begin{equation}
    \frac{dl}{dt} =  \kappa\, \frac{l}{\lambda S(t)} \frac{\ln{2}}{T_{1/2}} \left( S_{\max} - S(t)\right).
\end{equation}
If we substitute $S(t)$ from Eq.~\ref{eq:supply-time} and solve this differential equation against $l$, we get:
\begin{equation}
    l(t) = l(0)\,\left[ \frac{S(t)}{S_0} \right]^{\frac{\kappa}{\lambda}}.
\end{equation}
If $\kappa=1$ (staking for $1$~year+) and $\lambda=60\%$ ($60\%$ of all nodes in the network are staking),
miner's compensation starts from $0.46\%$~per~day in NKMS tokens,
or $l(1) - l(0) = 177.5\%$ during the first year of staking.

\subsection{Take mining rewards and spindown}

When the node spins down, its rewards are constantly decreased because the time left to unlock becomes smaller and smaller,
effectively decreasing $\kappa$ gradually towards $0.5$,
as well as the stake is linearly decreased towards zero.

\section{Edge cases: connection problems, vesting during unlocking}

\section{TLDR}

\bibliography{mining-paper}

\end{document}
